---
layout: post_notitle
title: 冻它说明
header-style: text
comments: false
excerpt: 冻它相关介绍，冻结模式，面具模块、Xposed模块作用等等
---

<div align="center">
<pre>
<img src = "/images/logo.png"/>
<font size="6"><strong>{{ page.title }}</strong></font>

</pre>
</div>


---

## 配置选项说明

1. **超时则杀死**：该应用进入后台超时就直接杀死，而不是冻结。该选项适合那些用完就丢、不用留后台的应用，冻它自动帮你杀掉。

1. **SIGSTOP冻结**：使用SIGSTOP信号进行冻结，该方式不考虑进程状态而强制冻结，有概率破坏应用的正常运行。

1. **Freezer冻结**：使用cgroup的Freezer子系统进行冻结，该方式会根据进程状态是否合适而冻结，可能会延迟冻结，甚至无限延迟。

1. **播放中不冻结**：停止播放后，若支持Freezer则使用该方式冻结，否则使用SIGSTOP。部分设备不能识别蓝牙播放状态，所以即使播放中也会冻结。

1. **后台自由**：该应用不会冻结，可在后台自由运行。

    **注**：冻它APP配置列表底部的应用，已内置为后台自由，不可更改配置。

---

## 冻结控制器说明

1. **Freezer** 是 **cgroup** 的其中一个子控制器，用于冻结进程的CPU使用。冻它日志顶部有说明本机当前支持的V1或V2版本，内核启动时一般只会启用其中一个，少数魔改内核会同时启用。**Freezer** 在冻结进程时，如果此时进程处于一些特殊状态(例如进程正在binder通信读写数据)，它会等待这个状态结束再冻结，也可能会取消冻结。

1. **FreezerV1** 很早便在内核中支持，3.x/4.x/5.x内核都会支持。部分内核的FreezerV1存在缺陷，进程PID被Freezer持有时(即冻结状态)无法被杀死，依旧占据内存，类似内存泄漏，需要解冻(thaw)才能结束进程并释放内存。这是内核级缺陷，应用层大概率无法解决，只能缓解，因此冻它依靠 **打开应用(解冻)** 和 **定时解冻** 操作来彻底结束这些异常的进程并释放其内存。

    - 注1：厂商基于V1的墓碑机制(例如FreezerV1版Millet)会捕获**杀进程信号**进而为其解冻，不存在内存无法释放问题。

1. **FreezerV2** 在 **5.4** 内核(Android11)起完整支持，该冻结模式的系统体验最好。部分厂商会移植到4.14~4.19内核中，但是可能没有完整移植而缺失 **BINDER_FREEZE** 特性，导致进程在冻结期间，binder驱动依旧为其工作，若此时应用收到 **binder同步** 请求，超时未响应则会被系统认为异常而杀掉，而FreezerV1、SIGSTOP也会这样。
  
    - 注1：MIUI的 **FreezerV1版Millet** 通过修改了内核binder驱动来获得binder同步事件进行解冻，避免了这个问题。而完整版FreezerV2则不用担心binder同步问题(异步binder请求会被系统缓存起来，等应用解冻了再处理，暂不清楚会不会像广播那样导致缓存溢出堵塞)。

    - 注2：一般 **4.14-4.19** 内核支持 **不完整的** 的FreezerV2，默认没有启用，如果想开启这种不完整FreezerV2，在冻它设置里开启挂载，重启即可，如果无法挂载，可在冻它群文件寻找其他挂载V2模块，若仍旧失败则说明内核不支持(部分高通设备才支持)。

    - 注3：主线 **5.4** 版本内核(Android11)起支持 [**BINDER_FREEZE**](https://cs.android.com/android/kernel/superproject/+/common-android11-5.4:common/drivers/android/binder.c;drc=da97a10882ba78cc036cc6b7b006dd057029b2e4;l=5043) 特性。

1. **SIGSTOP** 是Linux中编号19的系统信号，不能被进程捕获，一旦进程收到该信号则被立即强制暂停运行。这是底层Linux系统原始的进程控制机制，并不会考虑到上层安卓框架层应用的状态是否合适进行冻结，所以应用被 **SIGSTOP** 冻结时，其运行状态可能已经被破坏，重新回到前台解冻时，更容易发生闪退，重载等等现象。其冻结 **最为彻底** ，但 **容易出问题** (闪退，重载等)。

1. **FreezerV2(frozen)** 和 **FreezerV2(uid)** 仅仅是操作路径不同，效果没有区别，V1版同理。

    - **FreezerV2(frozen)路径**: */sys/fs/cgroup/[frozen/unfrozen]*

    - **FreezerV2(uid)路径**: */sys/fs/cgroup/uid_10xxx/pid_xxx*

    - **FreezerV1(frozen)路径**: */dev/jark_freezer/[frozen/unfrozen]*

    - **FreezerV1(uid)路径**: */dev/jark_freezer/uid_10xxx/pid_xxx*

1. 各种模式在冻它模块下的体验排行如下，仅从原理考虑出发，不一定符合全部情况，以个人实际体验为准：

    ```
    FreezerV2 > FreezerV2半残 = FreezerV1 > FreezerV1泄漏 ≈ SIGSTOP
    ```

### 总体区别


1. **Freezer** 会等待应用结束特殊运行状态再冻结，可能会推迟冻结，也可能无限推迟。

1. **SIGSTOP** 不考虑后果直接冻结，即使会导致应用异常。

---

## 模块说明

2. 冻它的前台状态判断比较严格，只有顶层显示窗口才算前台状态，包括 ***普通前台，分屏，MIUI小窗，原生小窗(FreeForm)，第二屏前台，virtualDisplay*** ，其他状态一律视为在后台，只有 **悬浮窗、常驻通知栏、音频播放服务** 等 **前台服务** 的应用也视为后台状态。

3. **悬浮窗** 暂时不能识别为前台应用，例如Scene的悬浮监视器等等，此时当做在后台处理，超时就冻结。所以B站悬浮的视频小窗口这类 **画中画** 悬浮窗，建议设为自由后台或播放中不冻结。

4. 请不要与其他功能类似的 **墓碑模块 / 墓碑模式 / 黑域 / 各类乖巧模式** 一同使用，避免冲突，暂时与系统自带的 **暂停执行已缓存的应用** 无冲突。

5. 底层进程与App通信采用TCP_SOCKET(本地环回 **127.0.0.1:60613** ，模块为Server，APP为Client)，因此通信范围仅限本机内部，没有隐私泄漏风险。

6. 仅接管 **第三方应用** 冻结，不会接管系统应用(以后的版本也不会)，部分系统辅助类应用以第三方应用形式存在(可卸载)，被冻结后会导致系统异常，请手动设为自由后台，若发现此类应用，请及时给作者反馈加入内置自由后台。

7. 在MIUI下，为防止机制冲突，模块会自动禁用系统自带的 **Millet** ，这是MIUI自身的墓碑机制。

8. 模块文件大多位于模块目录内，卸载模块时会自动跟随删除，以下两个文件例外：

    + 模块发生异常时，异常日志会追加到: **/sdcard/Android/freezeit_crash_log.txt** ，若存在异常内容，请向作者反馈。若运行一切正常，则不会出现该文件。

    + 模块会创建一个配置文件给 **冻它Xposed** ，位于 **/data/system/freezeit.conf** ，普通用户不用理会这个。

9. 移除冻它Magisk模块时，在重启阶段，冻它的卸载脚本会删除以上两个文件，同时卸载冻它APP。

10. 如果使用冻它过程开启了Doze功能， **系统的电池优化白名单中的第三方应用会被替换成冻它的自由后台(包括内置)应用** ，这是本模块唯一的 **残留内容** 。

---

## 冻它Xposed模块说明

1. 安卓进程在冻结状态无法正常响应安卓框架的各类服务请求，容易导致严重副作用，故Xposed的作用则是解决这类问题。

2. **广播处理** ：应用在冻结状态无法响应各种广播，这些广播会积累在系统缓存中，直到系统无法处理其他新生的广播，也就是广播堵塞，而拨号、安装应用程序等等行为都需要广播通信，此时这些行为会堵在某个阶段，临时解决方法是一键清理后台，这样系统会顺带清理传递给这些应用的广播，暂时获得广播畅通，但随着时间推移依旧会慢慢积累堵塞。冻它则会拦截发往冻结应用的广播，避免其无法处理而堵塞。

3. **ANR处理** ：应用在冻结状态，超时没有响应系统某些服务或状态问询时，系统会弹窗提示 ***XXX应用未响应*** 询问等待还是关闭应用，冻它会屏蔽这个弹窗。如果无法响应的是重要且限时应答的系统服务，此时应用会被系统认为严重异常而杀死，同时在 **/data/anr/** 下输出异常日志。

4. **唤醒锁(WakeupLock)处理** TODO  未完成：应用一旦获得唤醒锁，系统将不会进入待机休眠，即使息屏待机状态的CPU会一直保持运转，如果应用被冻结则无法主动释放唤醒锁。冻它会禁止黑名单的应用获得唤醒锁，无论任何状态下。而设为播放不冻结的应用允许获得，但是冻结时会将其唤醒锁状态设为可忽略，解冻时恢复。

5. **定时器(Alarm)处理** TODO 未完成：应用一旦设置了定时器，到了其设定的时间会被系统唤醒运行，这种后台唤醒操作及其唤醒后的运行都是在后台默默运行，产生不必要耗电，因此冻它会禁止黑名单及播放中不冻结的应用设定定时器。

6. **同步服务(SyncService)** ：TODO 暂不处理。某些应用会借用系统的 **账号同步** 服务实现后台驻留保活。

7. **后台服务(Service)** ：TODO 暂不处理。

---

## 注意项

1. **冻它面具模块** 是墓碑机制的核心，而 **冻它Lsposed模块** 负责解决安卓系统使用墓碑的副作用，缺一不可。冻它Xposed需要勾选 **系统框架** ，MIUI可选择是否勾选 **电量与性能** ，主要用于禁用其杀后台功能。

2. 目前的模块的广播处理应该不容易导致卡通话、卡短信接收，卡安装应用等等问题，如果偶尔遇到，使用系统 **一键清理后台** 即可，若经常遇到，请向作者反馈。

3. 目前冻它的广播拦截机制不完善，设为冻结的应用，即使在前台，也可能会拦截其广播，导致其部分功能不可用或不能使用，例如爱玩机不能获取电池信息，面具卡在启动页等等，暂时只能加入自由后台才能解决。

4. 如果 **面具Magisk** 应用进行了隐藏操作，使用了随机包名、名称，默认配置不是自由后台，冻它可能会拦截其广播而导致 **启动页面卡住** ，请设为自由后台。原生包名及Delta版包名已内置自由后台。

5. 如遇其他问题，请加入 **[冻它交流群](https://jq.qq.com/?_wv=1027&k=Q5aVUglt)** 进行讨论。

---

## 其他

1. ### 冻结QQ/TIM并开启消息推送

    即使QQ已经接入了MiPush或HMSPush消息推送，但冻结QQ之后，系统仍旧保持着QQ:MSF进程和腾讯服务器的连接，所以腾讯那边不会通过第三方消息推送。冻它目前不能单独切断其网络连接，只能通过杀死MSF进程或者切换手机网络方式来关闭其连接状态。目前腾讯只开放少数用户使用MiPush，而HMSPush则是全部开放，以下介绍安装HMSPush步骤：

    1. 在酷安或任意应用市场搜索安装 **HMS Core** (建议使用Scene将其转为系统应用)；

    2. 在 **LSPosed仓库** 中搜索安装 **HMSPush** ，勾选 **系统框架、系统界面、HMS Core、QQ/TIM、或者其他支持HMS推送的应用** 。

    3. 重启系统，打开 **QQ/TIM** ，再打开 **HMSPush** 检测其是否已经注册，若已注册，说明可以使用推送了，否则就再重启系统，打开QQ，检测是否已注册。

    4. 在冻它设置中，开启 **杀死MSF** 功能，然后去冻结或杀死 **QQ/TIM** ，此时可以去测试是否可以接收HMS推送，该推送弹窗图标是应用的图标，而不是QQ那种带对方/群头像的消息弹窗。

        ![P1](/images/2022-11-15P4.png)

2. ### 检查冻结状态
    
    冻它进行冻结操作后，如果是Freezer模式，进程并非百分百进入冻结状态，因为进程在某些状态下，Freezer控制器就不会冻结它，否则会破坏进程运行状态，这种时候，你可以选择任由这样，或者换成SIGSTOP，即使冻结可能会导致终结应用。

    1. 点击冻它APP日志页右上角的 **雪花按钮**，日志会列出当前第三方应用进程的wchan状态，可以检查是否被冻结。

        ![P1](/images/2022-11-15P3.png)

    1. 如果是其他墓碑，请使用   **Termux终端**，先输入 **su** 执行进入管理员账户，再选择以下其中一个命令执行，结果解释：

        - FreezerV1冻结状态: **__refrigerator**

        - FreezerV2冻结状态: **do_freezer_trap**

        - SIGSTOP冻结状态：**do_signal_stop**

        - 不完整FreezerV2冻结状态：**get_signal**

        - 其他状态，一般是应用正常运行中的各种状态：
            - **xxx_epoll_wait**：等待事件触发；
            - **binder_ioctl_xxx**：binder通信中；
            - 等等

    1. 此命令直接只会过滤出当前已冻结的进程信息，没有冻结的不会显示出来：

        ```sh
        ps -A | grep -E "refrigerator|do_freezer|signal"
        ```

        ![P1](/images/2022-11-15P1.png)

    1. 此命令会显示所有安卓应用进程的状态信息，无论是否冻结状态：

        ```sh
        ps -A | grep u0_a
        ```

        ![P1](/images/2022-11-15P2.png)


---

## 冻它APP预览

![冻它APP预览](/images/app_preview.png)

---

## 相关链接

[酷安 @JARK006](https://www.coolapk.com/u/1212220)

[Github 发布页面](https://github.com/jark006/freezeitRelease)

[蓝奏云](https://jark006.lanzout.com/b017oz9if) 密码: dy6i

[QQ群组 781222669](https://jq.qq.com/?_wv=1027&k=Q5aVUglt)

[QQ频道 冻它模块](https://qun.qq.com/qqweb/qunpro/share?_wv=3&_wwv=128&appChannel=share&inviteCode=1W6opB7&businessType=9&from=246610&biz=ka)

[Telegram 群组](https://t.me/+sjDX1oTk31ZmYjY1)

[Telegram 频道](https://t.me/freezeitRelease)


